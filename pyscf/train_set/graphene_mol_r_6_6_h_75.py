###### capture the output ##########
import sys
old_stdout = sys.stdout
log_file = open("graphene_mol_r_6_6_h_75.out","w")
sys.stdout = log_file
###### capture the output ##########

import json
from pyscf import gto, dft
from pyscf.geomopt.geometric_solver import optimize
import time
#

print(time.time())

structure_n = 75

N_index = [27,40,60,66]
    
coords = [[-7.33822558, 5.04275976, 0.],
 [-7.36522779, 0.69113897, 0.],
 [-6.17364189, 2.88941346, 0.],
 [-4.91009039, 5.01961697, 0.],
 [-7.35805126, -3.64263535, 0.],
 [-6.17347496, -1.43178513, 0.],
 [-4.94006858, 0.7166888, 0.],
 [-3.69484499, 2.86031161, 0.],
 [-2.45722371, 5.00571499, 0.],
 [-6.13851529, -5.72724589, 0.],
 [-4.92821411, -3.58007057, 0.],
 [-3.69816891, -1.42557093, 0.],
 [-2.47177924, 0.71653958, 0.],
 [-1.23070473, 2.851907, 0.],
 [0., 5.00316853, 0.],
 [-3.67896605, -5.69405235, 0.],
 [-2.46601455, -3.56092261, 0.],
 [-1.23242295, -1.4232072, 0.],
 [0., 0.71580893, 0.],
 [1.23070473, 2.851907, 0.],
 [2.45722371, 5.00571499, 0.],
 [-1.22633444, -5.68507971, 0.],
 [0., -3.55707854, 0.],
 [1.23242295, -1.4232072, 0.],
 [2.47177924, 0.71653958, 0.],
 [3.69484499, 2.86031161, 0.],
 [4.91009039, 5.01961697, 0.],
 [1.22633444, -5.68507971, 0.],
 [2.46601455, -3.56092261, 0.],
 [3.69816891, -1.42557093, 0.],
 [4.94006858, 0.7166888, 0.],
 [6.17364189, 2.88941346, 0.],
 [7.33822558, 5.04275976, 0.],
 [3.67896605, -5.69405235, 0.],
 [4.92821411, -3.58007057, 0.],
 [6.17347496, -1.43178513, 0.],
 [7.36522779, 0.69113897, 0.],
 [6.13851529, -5.72724589, 0.],
 [7.35805126, -3.64263535, 0.],
 [-7.35805126, 3.64263535, 0.],
 [-6.13851529, 5.72724589, 0.],
 [-7.36522779, -0.69113897, 0.],
 [-6.17347496, 1.43178513, 0.],
 [-4.92821411, 3.58007057, 0.],
 [-3.67896605, 5.69405235, 0.],
 [-7.33822558, -5.04275976, 0.],
 [-6.17364189, -2.88941346, 0.],
 [-4.94006858, -0.7166888, 0.],
 [-3.69816891, 1.42557093, 0.],
 [-2.46601455, 3.56092261, 0.],
 [-1.22633444, 5.68507971, 0.],
 [-4.91009039, -5.01961697, 0.],
 [-3.69484499, -2.86031161, 0.],
 [-2.47177924, -0.71653958, 0.],
 [-1.23242295, 1.4232072, 0.],
 [0., 3.55707854, 0.],
 [1.22633444, 5.68507971, 0.],
 [-2.45722371, -5.00571499, 0.],
 [-1.23070473, -2.851907, 0.],
 [0., -0.71580893, 0.],
 [1.23242295, 1.4232072, 0.],
 [2.46601455, 3.56092261, 0.],
 [3.67896605, 5.69405235, 0.],
 [0., -5.00316853, 0.],
 [1.23070473, -2.851907, 0.],
 [2.47177924, -0.71653958, 0.],
 [3.69816891, 1.42557093, 0.],
 [4.92821411, 3.58007057, 0.],
 [6.13851529, 5.72724589, 0.],
 [2.45722371, -5.00571499, 0.],
 [3.69484499, -2.86031161, 0.],
 [4.94006858, -0.7166888, 0.],
 [6.17347496, 1.43178513, 0.],
 [7.35805126, 3.64263535, 0.],
 [4.91009039, -5.01961697, 0.],
 [6.17364189, -2.88941346, 0.],
 [7.36522779, -0.69113897, 0.],
 [7.33822558, -5.04275976, 0.],
 [8.28218407, 5.59142473, 0.],
 [8.32574063, 3.14110602, 0.],
 [8.32671501, 1.20466149, 0.],
 [8.32671501, -1.20466149, 0.],
 [8.32574063, -3.14110602, 0.],
 [8.28218407, -5.59142473, 0.],
 [-8.28218407, 5.59142473, 0.],
 [-8.32574063, 3.14110602, 0.],
 [-8.32671501, 1.20466149, 0.],
 [-8.32671501, -1.20466149, 0.],
 [-8.32574063, -3.14110602, 0.],
 [-8.28218407, -5.59142473, 0.],
 [-6.1166254, 6.81942666, 0.],
 [-3.67275689, 6.78743124, 0.],
 [-1.22557981, 6.77840775, 0.],
 [1.22557981, 6.77840775, 0.],
 [3.67275689, 6.78743124, 0.],
 [6.1166254, 6.81942666, 0.],
 [-6.1166254, -6.81942666, 0.],
 [-3.67275689, -6.78743124, 0.],
 [-1.22557981, -6.77840775, 0.],
 [1.22557981, -6.77840775, 0.],
 [3.67275689, -6.78743124, 0.],
 [6.1166254, -6.81942666, 0.]]

species = ['C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 
           'C', 'C', 'C', 'C', 'C', 'C', 'H', 'H', 'H', 'H', 'H', 'H', 
           'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 
           'H', 'H', 'H', 'H', 'H', 'H']

N_N = len(N_index)

for index in N_index:
    species[index] = 'N'

# Convert to PySCF molecule format
mol = gto.Mole()
mol.atom = [[str(species[i]), coord] for i, coord in enumerate(coords)]
mol.basis = 'ccpvtz'
mol.spin = N_N%2
mol.build()

# Perform DFT calculation
mf = dft.RKS(mol)
mf.xc = 'pbe0'

mol_eq = optimize(mf,maxsteps=200)

mf_eq = dft.RKS(mol_eq)
mf_eq.xc = 'pbe0'
mf_eq.spin = N_N%2
energy = mf_eq.kernel()


mf_eq.analyze()
mo_energies = mf_eq.mo_energy.tolist()
mulliken_charges = mf_eq.mulliken_pop()[1].tolist()
dipole_moment = mf_eq.dip_moment().tolist()

# Save results to a JSON file
results = {
    "energy": energy,
    "MO_energies": mo_energies,
    "Mulliken_charges": mulliken_charges,
    "dipole_moment": dipole_moment
}

with open("graphene_mol_r_6_6_h_{}.json".format(structure_n), "w") as json_file:
    json.dump(results, json_file, indent=4)

atom_coords = mol_eq.atom_coords()
atom_charges = mol_eq.atom_charges()
num_atoms = len(atom_coords)

with open('graphene_mol_r_6_6_h_{}.xyz'.format(structure_n), 'w') as f:
    f.write(f"{num_atoms}\n")
    f.write("Optimized geometry\n")
    for i in range(num_atoms):
        symbol = gto.mole._symbol(atom_charges[i])
        x, y, z = atom_coords[i]
        f.write(f"{symbol} {x:.6f} {y:.6f} {z:.6f}\n")
 

print(time.time())

###### capture the output ##########
sys.stdout = old_stdout
log_file.close()
###### capture the output ##########
